name: Node.js CI
# ğŸ“Œ DÃ©clencheurs : ce workflow s'exÃ©cute :
# - Ã  chaque push sur main, develop ou une branche feature/*
# - Ã  chaque pull request vers main
on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    # ğŸ’» Machine virtuelle sur laquelle le job s'exÃ©cute
    runs-on: ubuntu-latest

    services:
      # ğŸ“¦ Services nÃ©cessaires au job (ici une base PostgreSQL Docker)
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: blogapi
          POSTGRES_PASSWORD: blogapi
          POSTGRES_DB: blogapi
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # ğŸ” Variables d'environnement accessibles dans le job
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: blogapi
      DB_PASSWORD: blogapi
      DB_NAME: blogapi
      JWT_SECRET: supersecret

    steps:
      # 1ï¸âƒ£ RÃ©cupÃ©rer le code source du repo
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Installer Node.js (ici version 20)
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3ï¸âƒ£ Installer les dÃ©pendances dÃ©clarÃ©es dans package.json
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Attendre que la base PostgreSQL soit opÃ©rationnelle
      - name: ğŸ› ï¸ Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432; do
            echo "â³ Waiting for database..."
            sleep 2
          done

      # 5ï¸âƒ£ ExÃ©cuter le script SQL pour crÃ©er les tables et rÃ´les initiaux
      - name: ğŸ—„ï¸ Seed Database
        run: npm run seed-db

      # 6ï¸âƒ£ Lancer les tests unitaires et fonctionnels avec Node.js
      - name: ğŸš€ Run tests
        run: npm run test
